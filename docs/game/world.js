function bufToRuid(o,i){let t="";for(let e=0;e<16;e++)t+=("0"+o[i+e].toString(16)).slice(-2);return t}function ruidToBuf(o,i,t){for(let e=0;e<16;e++)i[t+e]=parseInt(o.substr(2*e,2),16)}class World{constructor(){this.regions={},this.tiles={},this.loadedPositionMin={x:NaN,y:NaN},this.defaultTile=new Tile("00000000000000000000000000000000","Unknown","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4woIEBISRGtRKQAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAJElEQVQoz2NkwAH+M/zHKs7EQCIY1UAMYMQV3owMjKOhRD8NACTzBB3yj0euAAAAAElFTkSuQmCC",""),socket.emit("WorldSetTile",0,1,"65a5fce8876d8e5bad5da510edb9a3f"),socket.emit("WorldSetTile",1,-1,"65a5fce8876d8e5bad5da510edb9a3f")}fetch(o,i){socket.emit("WorldGetRegion",256*o,256*i,t=>{void 0===this.regions[o]&&(this.regions[o]={}),this.regions[o][i]=new Uint8Array(t),console.log("loadedregion: ",o,"/",i);let e={};for(let t=0;t<1048576;t+=16){const s=bufToRuid(this.regions[o][i],t);"00000000000000000000000000000000"!=s&&void 0===this.tiles[s]&&void 0===e[s]&&(e[s]=!0,console.log("loadtile@",t))}for(const o of Object.keys(e))socket.emit("WorldGetTile",o,(i,t)=>{i?this.tiles[o]=new Tile(o,t.name,t.graphic,t.code):(console.error("Error getting tile #"+o),this.tiles[o]=this.defaultTile)})})}update(){const o={x:Math.floor((player.x-128)/256),y:Math.floor((player.y-128)/256)};let i={};i.ll=!(o.x!=this.loadedPositionMin.x&&o.x!=this.loadedPositionMin.x+1||o.y!=this.loadedPositionMin.y&&o.y!=this.loadedPositionMin.y+1),i.lh=!(o.x!=this.loadedPositionMin.x&&o.x!=this.loadedPositionMin.x+1||o.y+1!=this.loadedPositionMin.y&&o.y+1!=this.loadedPositionMin.y+1),i.hl=!(o.x+1!=this.loadedPositionMin.x&&o.x+1!=this.loadedPositionMin.x+1||o.y!=this.loadedPositionMin.y&&o.y!=this.loadedPositionMin.y+1),i.hh=!(o.x+1!=this.loadedPositionMin.x&&o.x+1!=this.loadedPositionMin.x+1||o.y+1!=this.loadedPositionMin.y&&o.y+1!=this.loadedPositionMin.y+1),i.ll||this.fetch(o.x,o.y),i.lh||this.fetch(o.x,o.y+1),i.hl||this.fetch(o.x+1,o.y),i.hh||this.fetch(o.x+1,o.y+1),this.loadedPositionMin=o}draw(){let o=Math.ceil(vpSize.x/camera.zoom/2),i=Math.ceil(vpSize.y/camera.zoom/2);for(let t=Math.floor(camera.x)-o;t<=Math.floor(camera.x)+o;t++)for(let o=Math.floor(camera.y)-i;o<=Math.floor(camera.y)+i;o++){const i=this.getTile(t,o);0!==i&&void 0!==this.tiles[i]&&this.tiles[i].draw(t,o)}}getTile(o,i){return void 0!==this.regions[Math.floor(o/256)]&&void 0!==this.regions[Math.floor(o/256)][Math.floor(i/256)]?bufToRuid(this.regions[Math.floor(o/256)][Math.floor(i/256)],16*((255&o)+256*(255&i))):"00000000000000000000000000000000"}setTile(o,i,t){void 0!==this.regions[Math.floor(o/256)]&&void 0!==this.regions[Math.floor(o/256)][Math.floor(i/256)]?ruidToBuf(t,this.regions[Math.floor(o/256)][Math.floor(i/256)],16*((255&o)+256*(255&i))):console.error("Error: SetTile in unloaded region.")}}
