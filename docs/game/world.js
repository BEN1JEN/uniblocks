"use strict";function bufToRuid(i,o){let t="";for(let e=0;e<16;e++)t+=("0"+i[o+e].toString(16)).slice(-2);return t}function ruidToBuf(i,o,t){for(let e=0;e<16;e++)o[t+e]=parseInt(i.substr(2*e,2),16)}class World{constructor(){this.regions={},this.tiles={},this.loadedPositionMin={x:NaN,y:NaN},this.defaultTile=new Tile("00000000000000000000000000000000","Unknown","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4woIEBISRGtRKQAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAJElEQVQoz2NkwAH+M/zHKs7EQCIY1UAMYMQV3owMjKOhRD8NACTzBB3yj0euAAAAAElFTkSuQmCC","");for(let i=-3;i<=3;i++)socket.emit("WorldSetTile",i,-3,"65a5fce8876d8e5bad5da510edb9a3f"),socket.emit("WorldSetTile",3,i,"65a5fce8876d8e5bad5da510edb9a3f");socket.emit("WorldSetTile",0,0,"65a5fce8876d8e5bad5da510edb9a3f")}loadTile(i,o){void 0===this.tiles[i]?socket.emit("WorldGetTile",i,(t,e)=>{t?this.tiles[i]=new Tile(i,e.name,e.graphic,e.code):(console.error("Error getting tile #"+i),this.tiles[i]=this.defaultTile),"function"==typeof o&&o(this.tiles[i])}):"function"==typeof o&&o(this.tiles[i])}fetch(i,o){socket.emit("WorldGetRegion",i,o,t=>{void 0===this.regions[i]&&(this.regions[i]={}),this.regions[i][o]=new Uint8Array(t),console.log("loadedregion: ",i,"/",o);let e={};for(let t=0;t<1048576;t+=16){const s=bufToRuid(this.regions[i][o],t);"00000000000000000000000000000000"!==s&&void 0===this.tiles[s]&&void 0===e[s]&&(e[s]=!0,console.log("loadtile@",t))}for(const i of Object.keys(e))this.loadTile(i)})}update(){const i={x:Math.floor((player.collider.x-128)/256),y:Math.floor((player.collider.y-128)/256)};let o={};o.ll=!(i.x!==this.loadedPositionMin.x&&i.x!==this.loadedPositionMin.x+1||i.y!==this.loadedPositionMin.y&&i.y!==this.loadedPositionMin.y+1),o.lh=!(i.x!==this.loadedPositionMin.x&&i.x!==this.loadedPositionMin.x+1||i.y+1!==this.loadedPositionMin.y&&i.y+1!==this.loadedPositionMin.y+1),o.hl=!(i.x+1!==this.loadedPositionMin.x&&i.x+1!==this.loadedPositionMin.x+1||i.y!==this.loadedPositionMin.y&&i.y!==this.loadedPositionMin.y+1),o.hh=!(i.x+1!==this.loadedPositionMin.x&&i.x+1!==this.loadedPositionMin.x+1||i.y+1!==this.loadedPositionMin.y&&i.y+1!==this.loadedPositionMin.y+1),o.ll||this.fetch(i.x,i.y),o.lh||this.fetch(i.x,i.y+1),o.hl||this.fetch(i.x+1,i.y),o.hh||this.fetch(i.x+1,i.y+1),this.loadedPositionMin=i}draw(){let i=Math.ceil(vpSize.x/camera.zoom/2),o=Math.ceil(vpSize.y/camera.zoom/2);for(let t=Math.floor(camera.x)-i;t<=Math.floor(camera.x)+i;t++)for(let i=Math.floor(camera.y)-o;i<=Math.floor(camera.y)+o;i++){const o=this.getTile(t,i);0!==o&&void 0!==this.tiles[o]&&this.tiles[o].draw(t,i)}}getTile(i,o){return void 0!==this.regions[Math.floor(i/256)]&&void 0!==this.regions[Math.floor(i/256)][Math.floor(o/256)]?bufToRuid(this.regions[Math.floor(i/256)][Math.floor(o/256)],16*((255&i)+256*(255&o))):"00000000000000000000000000000000"}setTile(i,o,t){void 0!==this.regions[Math.floor(i/256)]&&void 0!==this.regions[Math.floor(i/256)][Math.floor(o/256)]&&ruidToBuf(t,this.regions[Math.floor(i/256)][Math.floor(o/256)],16*((255&i)+256*(255&o)))}}
